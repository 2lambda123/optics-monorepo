name: Push to Artifact Registry GitHub Action
on:
  push:
    branches:
      - 'main'
  pull_request:
  workflow_dispatch:
jobs:
  print_jwt_tokens:
    runs-on: ubuntu-latest
    steps:
      - name: Akeyless Get Secrets
        id: get_auth_token
        uses: docker://us-docker.pkg.dev/clabs-secrets-and-permissions/public-images/akeyless-actions:latest
        with:
          #api-url: https://api.gateway.akeyless.celo-networks-dev.org
          #access-id:  p-kf9vjzruht6l
          akeyless-api-gateway: https://api.gateway.akeyless.celo-networks-dev.org
          akeyless-github-access-id: p-kf9vjzruht6l

      - name: echo var
        run: |
          echo "${{ env.GITHUB_AUTH_JWT }}"

  Build-Container-dev:
    uses: celo-org/reusable-workflows/.github/workflows/container-cicd.yaml@v1.1
    if: github.ref != 'refs/heads/main'
    with:
      workload-id-provider: projects/1094498259535/locations/global/workloadIdentityPools/gh-optics-monorepo/providers/github-by-repos
      service-account: optics-monorepo-images-dev@devopsre.iam.gserviceaccount.com 
      artifact-registry: ${{ vars.DEV_IMAGE_REPO }}/optics-agent
      tag: testing
      context: ./rust
      file: ./rust/Dockerfile

  Build-Container:
    uses: celo-org/reusable-workflows/.github/workflows/container-cicd.yaml@v1.1
    if: github.ref == 'refs/heads/main'
    with:
      workload-id-provider: projects/1094498259535/locations/global/workloadIdentityPools/gh-optics-monorepo-main/providers/github-by-repos
      service-account:  optics-monorepo-images@devopsre.iam.gserviceaccount.com
      artifact-registry: us-west1-docker.pkg.dev/devopsre/optics-monorepo/optics-agent
      tag: latest
      context: ./rust
      file: ./rust/Dockerfile
